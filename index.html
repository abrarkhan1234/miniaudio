<html>
<head>
	<title>Miniaudio Player Spike</title>
	<link media="screen" href="/demo/miniaudio/style/styles.css" type="text/css" rel="stylesheet">
</head>
<body>
	<h1>Mini Audio Player Spike</h1>
	<div id="content-panel">
		<div class="links-container"> 
			<ul> 
				<li><span>Polluted Water</span><a data-src="http://www.bbc.co.uk/iplayer/playlist/p01wztdy" href="#">Play</a></li> 
				<li><span>Salt Water</span><a data-src="http://www.bbc.co.uk/iplayer/playlist/p01x1fxw" href="#">Play</a></li> 
				<li><span>Drinking Water</span><a data-src="http://www.bbc.co.uk/iplayer/playlist/p01x1fzn/" href="#">Play</a></li> 
				<li><span>Scott Mills</span><a data-src="http://www.bbc.co.uk/iplayer/playlist/p01nbkcj" href="#">Play</a></li> 
				<li><span>Reports</span><a data-src="http://www.bbc.co.uk/iplayer/playlist/p01nbkvl" href="#">Play</a></li> 
				<li><span>Bobby Friction</span><a data-src="http://www.bbc.co.uk/iplayer/playlist/p01nbk3q/" href="#">Play</a></li> 
			</ul> 
		</div>
		<br />
		<div id="media-player" style="height:270px;width:480px;"></div><br />
	</div>

	<div id="error-console"> 
		<h2>Error Console</h2> 
		<span class="reset"><a href="#">Reset Console</a></span> 
		<div id="error-container"></div> 
	</div>
	<script type="text/javascript" src="http://static.bbci.co.uk/frameworks/requirejs/0.13.0/sharedmodules/require.js"></script>
	<script type="text/javascript">
	/*global define, require*/
	define('kandl/media/miniaudio', function () {
	    'use strict';

	    var currentLink = null;
	    var errorNumber = 1;
	    var playAudio = false;
	    var errorContainer = document.querySelector('#error-container');
	    var playerElement = document.querySelector('#media-player');
	    require(['bump-3'], function ($) {
	        var settings = {
	            product: 'iplayer',
	            playerProfile: 'smp',
	            disable3GWarning: true,
	            mediator: {
	                'host': 'open.live.bbc.co.uk'
	            },
	            responsive: true
	        };

	        var mediaPlayer = $(playerElement).player(settings);
	        mediaPlayer.load('http://www.bbc.co.uk/iplayer/playlist/p01nbk3q');
	        playerElement.style.width = '1px';
	        playerElement.style.height = '1px';
	        
	        mediaPlayer.bind('initialised', function () {
	                printToConsole('player initialised');
	            }
	        );

	        mediaPlayer.bind('playing', function () {
	                if (playAudio === false ) {
	                    printToConsole('play not allowed');
	                    mediaPlayer.stop();
	                } else {
	                    printToConsole('player playing');
	                    currentLink.innerHTML = 'Playing';
	                    currentLink.className = 'playing';
	                }
	            }
	        );
	        
	        mediaPlayer.bind('ended', function () {
	                printToConsole('player stopped');
	                currentLink.innerHTML = 'Stopped';
	                currentLink.className = 'stopped';
	            }
	        );

	        mediaPlayer.bind('playlistLoaded', function () {
	                printToConsole('player playlistLoaded');
	            }
	        );

	        mediaPlayer.bind('error', function (e) {
	                var span = document.createElement('span');
	                span.className = 'error-message';
	                span.innerHTML = errorNumber + ') Error Code = ' + e.code +
	                    '<br /> Playlist URL = ' + e.detail;
	                errorContainer.appendChild(span);
	                errorNumber++;
	            }
	        );
	        
	        var clearButton = document.querySelector('#error-console .reset a');
	        clearButton.addEventListener('click', function (e) {
	            e.preventDefault();
	            clearConsole();
	        });

	        var links = document.querySelectorAll('.links-container a');
	        for (var i = 0; i < links.length; i++) {
	                var link = links[i]; 
	                link.addEventListener('click', function (e) {
	                e.preventDefault();
	                e.stopPropagation();
	                printToConsole('link clicked');
	                currentLink = this;

	                if (this.innerHTML === 'Playing') {
	                    mediaPlayer.stop();
	                    this.innerHTML = 'Play';
	                } else if (this.innerHTML === 'Loading') {
	                    printToConsole('play cancelled');
	                    playAudio = false;
	                    this.innerHTML = 'Cancelled';
	                } else {
	                    for (var j = 0; j < links.length; j++) {
	                        links[j].innerHTML = 'Play';
	                        links[j].className = '';
	                    }
	                    var playlist = this.getAttribute('data-src');
	                    this.innerHTML = 'Loading';
	                    this.className = 'loading';
	                    mediaPlayer.loadPlaylist(playlist, true);
	                    playAudio = true;
	                }
	            });
	        }
	        
	        function printToConsole(string) {
	            var span = document.createElement('span');
	            span.className = 'error-message';
	            span.innerHTML = errorNumber + ') ' + string + '<br />';
	            errorContainer.appendChild(span);
	            errorNumber++;
	        }
	        
	        function clearConsole() {
	            errorContainer.innerHTML = '';        
	        }
	    });
	});
	
	
    </script>
	<script type="text/javascript">
		bbcRequireMap = {
			"jquery-1.9":"http://static.bbci.co.uk/frameworks/jquery/0.3.0/sharedmodules/jquery-1.9.1",
			"swfobject-2":"http://static.bbci.co.uk/frameworks/swfobject/0.1.10/sharedmodules/swfobject-2",
				"bump-3":"http://emp.bbci.co.uk/emp/bump-3/bump-3"
		}
		require({ paths: bbcRequireMap, waitSeconds: 30 });
		require(["kandl/media/miniaudio"], function(media) {});
		
		
	</script>
</body>
</html>
